<script type="text/javascript">
    // Create a global object to store handlers for different node instances
    var unitNodeHandlers = {};
    
    RED.events.on("editor:open", function(node) {
        if (node.type === "unit-node") {
            if (!$('#unit-node-dialog-styles').length) {
                $('head').append(
                    '<style id="unit-node-dialog-styles">' +
                    '.red-ui-editor .red-ui-tray-content { width: 850px !important; }' +
                    '.red-ui-editor .red-ui-tray-content .red-ui-tray-content-content { width: 850px !important; }' +
                    '.red-ui-editor .form-row input, .red-ui-editor .form-row select { width: 70%; }' +
                    '.form-row input[type="hidden"] + div.red-ui-typedInput-container { width: 70% !important; }' +
                    '.red-ui-editor-stack { right: calc(100% - 850px) !important; }' +
                    '.red-ui-editor .red-ui-tray-footer { width: 850px; }' +
                    '.template-row .select2-container { width: 100% !important; }' +
                    '.template-row .select2-container .select2-selection { height: 36px !important; }' +
                    '.template-row .select2-container .select2-selection .select2-selection__rendered { line-height: 36px !important; }' +
                    '.template-row .select2-container .select2-selection .select2-selection__arrow { height: 36px !important; }' +
                    '</style>'
                );
            }
        }
    });

    RED.events.on("editor:close", function(node) {
        if (node.type === "unit-node") {
            $('#unit-node-dialog-styles').remove();
        }
    });

    RED.nodes.registerType('unit-node',{
        category: 'custom',
        color: '#a6bbcf',
        defaults:{
            name:{value:""},
            payload:{value:""},
            topic:{value:"", required:true},
            qos: {value:"0"},
            prompt: {value:""},
            objective: {value:""},
            hasBeenSaved: {value: false},
            
            templates: {value:[
                {subject:"", predicate:"", object:"", enableStorage: false}
            ]},
            
            apiEndpoint: {value:""},
            
            functions: {value:[
                {name:"Function 1", code:""}
            ]}
        },
        inputs:1,
        outputs:1,
        icon:'bridge.png',
        label:function(){
            return this.name||'unit node';
        },
        labelStyle: function(){
            return this.name?"node_label_italic":"";
        },
        onpaletteadd: function() {
            // General message handler for all unit-node nodes
            function handleUnitNodeMessage(topic, data) {
                console.log("Received unit_node_history message:", data);
                if (data && data.id && data.msg) {
                    var nodeId = data.id;
                    
                    // Store the received data in our handlers object
                    if (!unitNodeHandlers[nodeId]) {
                        unitNodeHandlers[nodeId] = { data: [] };
                    }
                    
                    // Update stored data
                    unitNodeHandlers[nodeId].data = data.msg;
                    
                    // If node is currently being edited, update its UI
                    var activeNode = RED.nodes.node(nodeId);
                    if (activeNode && activeNode._config_dialog_open) {
                        var outputPreviewContainer = $("#node-output-preview");
                        if (outputPreviewContainer.length) {
                            outputPreviewContainer.empty();
                            
                            data.msg.forEach(function(msg, index) {
                                var content = typeof msg === 'object' ? 
                                    JSON.stringify(msg, null, 2) : msg.toString();
                                
                                var pre = $('<pre>').text(content);
                                outputPreviewContainer.append(pre);
                            });
                        }
                    }
                    
                    // Log for debugging
                    console.log("Received unit_node_history for node:", nodeId, data.msg);
                }
            }
            
            // Subscribe to all unit-node history messages
            RED.comms.subscribe("unit_node_history/+", handleUnitNodeMessage);
            
            // Clean up on palette removal
            this.onpaletteremove = function() {
                RED.comms.unsubscribe("unit_node_history/+", handleUnitNodeMessage);
            };
        },
        oneditprepare: function() {
            var node = this;
            var outputPreviewContainer = $("#node-output-preview");
            var templateRowCounter = 0;
            
            // Set marker that this node is being edited
            node._config_dialog_open = true;

            // Ensure schema data is loaded
            if (!window.schemaData) {
                console.log("Loading schema data...");
                $.getJSON('data/schema.json', function(data) {
                    window.schemaData = data;
                    console.log("Schema data loaded:", data);
                    initializeTemplates();
                }).fail(function(jqXHR, textStatus, errorThrown) {
                    console.error("Failed to load schema:", textStatus, errorThrown);
                });
            } else {
                initializeTemplates();
            }
            
            // Display any existing data we already have
            if (unitNodeHandlers[this.id] && unitNodeHandlers[this.id].data) {
                var data = unitNodeHandlers[this.id].data;
                outputPreviewContainer.empty();
                
                data.forEach(function(msg, index) {
                    var content = typeof msg === 'object' ? 
                        JSON.stringify(msg, null, 2) : msg.toString();
                    
                    var pre = $('<pre>').text(content).css({
                        "margin-bottom": "10px",
                        "padding-bottom": "10px",
                        "border-bottom": index < data.length - 1 ? "1px solid #eee" : "none",
                        "word-wrap": "break-word",
                        "white-space": "pre-wrap"
                    });
                    outputPreviewContainer.append(pre);
                });
            }
            
            setupDialogEditor("prompt", "Prompt", "Enter the prompt text that will guide the processing");
            
            setupDialogEditor("objective", "Objective", "Define the objective of this processing step");
            
            function setupDialogEditor(fieldName, title, placeholder) {
                var fieldValue = node[fieldName] || "";
                var fieldPreview = fieldValue.length > 0 ? fieldValue : "Click to edit...";
                
                $("#node-input-" + fieldName + "-preview").text(fieldPreview);
                $("#node-input-" + fieldName).val(fieldValue);
                $("#node-input-" + fieldName + "-container").click(function() {
                    var editorDialog = $('<div id="node-input-' + fieldName + '-dialog" class="editor-dialog"></div>')
                        .appendTo("body")
                        .dialog({
                            title: title,
                            modal: true,
                            width: 800,
                            height: window.innerHeight * 0.8,
                            resizable: true,
                            open: function() {
                                var textarea = $('<textarea style="width: 100%; height: calc(100% - 40px); margin-bottom: 10px; resize: none; overflow-y: auto; overflow-x: hidden; white-space: pre-wrap; word-wrap: break-word;"></textarea>')
                                    .val($("#node-input-" + fieldName).val() || "")
                                    .attr("placeholder", placeholder)
                                    .appendTo(this);
                                    
                                var buttonRow = $('<div style="text-align: right;"></div>').appendTo(this);
                                
                                $('<button>Cancel</button>')
                                    .button()
                                    .appendTo(buttonRow)
                                    .click(function() {
                                        $(editorDialog).dialog('close');
                                    });
                                    
                                $('<button>Save</button>')
                                    .button()
                                    .css("margin-left", "10px")
                                    .appendTo(buttonRow)
                                    .click(function() {
                                        var value = textarea.val();
                                        $("#node-input-" + fieldName).val(value);
                                        
                                        var preview = value.length > 0 ? value : "Click to edit...";
                                        if (preview.length > 50) {
                                            preview = preview.substring(0, 47) + "...";
                                        }
                                        $("#node-input-" + fieldName + "-preview").text(preview);
                                        
                                        $(editorDialog).dialog('close');
                                    });
                            },
                            close: function() {
                                $(this).dialog('destroy');
                                $(this).remove();
                            }
                        });
                });
            }
            
            
            
            // Initialize the template container
            initializeTemplates();
                
            function initializeTemplates() {
                var templateContainer = $("#node-input-template-container");
                templateContainer.empty();
                
                // Load templates
                if (node.templates && node.templates.length) {
                    for (var i = 0; i < node.templates.length; i++) {
                        addTemplateRow(node.templates[i], templateRowCounter++);
                    }
                } else {
                    // Add default rows if none exist - using valid combinations from schema
                    console.log("window.schemaData", window.schemaData);
                    if (window.schemaData && window.schemaData.predicates) {
                        // Use first predicate from schema as default
                        var defaultPredicate = Object.keys(window.schemaData.predicates)[0];
                        var predicateInfo = window.schemaData.predicates[defaultPredicate];
                        
                        addTemplateRow({
                            subject: predicateInfo.subject_type,
                            predicate: defaultPredicate,
                            object: "",
                            enableStorage: false
                        }, templateRowCounter++);
                    } else {
                        // Fallback if schema isn't loaded yet
                        addTemplateRow({subject:"", predicate:"", object:"", enableStorage: false}, templateRowCounter++);
                    }
                }
            }
            
            // Setup add template button
            $("#node-input-add-template").click(function() {
                addTemplateRow({
                    subject: "",
                    predicate: "",
                    object: "",
                    enableStorage: false
                }, templateRowCounter++);
            });
            
            function addTemplateRow(template, rowIndex) {
                // Create a clean, compact row container
                var container = $('<div/>',{class:"form-row template-row"}).css({
                    "margin-bottom": "8px",
                    "position": "relative",
                    "padding": "6px 8px",
                    "background-color": "#f9f9f9",
                    "border-radius": "4px",
                    "display": "flex",
                    "align-items": "center",
                    "flex-wrap": "nowrap"
                });
                
                // Create wrapper divs for each field to handle custom input visibility
                var subjectWrapper = $('<div/>').css({
                    "flex": "1",
                    "margin-right": "8px",
                    "position": "relative"
                });
                
                var predicateWrapper = $('<div/>').css({
                    "flex": "1",
                    "margin-right": "8px",
                    "position": "relative"
                });
                
                var objectWrapper = $('<div/>').css({
                    "flex": "1",
                    "margin-right": "8px",
                    "position": "relative"
                });

                // Create custom input fields (initially hidden)
                var customSubjectInput = $('<input/>', {
                    type: 'text',
                    class: 'custom-input',
                    placeholder: 'Enter custom subject'
                }).css({
                    "width": "100%",
                    "display": "none",
                    "height": "36px",
                    "padding": "6px",
                    "font-size": "14px",
                    "border": "1px solid #ccc",
                    "border-radius": "4px"
                });

                var customPredicateInput = $('<input/>', {
                    type: 'text',
                    class: 'custom-input',
                    placeholder: 'Enter custom predicate'
                }).css({
                    "width": "100%",
                    "display": "none",
                    "height": "36px",
                    "padding": "6px",
                    "font-size": "14px",
                    "border": "1px solid #ccc",
                    "border-radius": "4px"
                });

                var customObjectInput = $('<input/>', {
                    type: 'text',
                    class: 'custom-input',
                    placeholder: 'Enter custom object'
                }).css({
                    "width": "100%",
                    "display": "none",
                    "height": "36px",
                    "padding": "6px",
                    "font-size": "14px",
                    "border": "1px solid #ccc",
                    "border-radius": "4px"
                });
                
                // Create subject dropdown
                var subjectField = $('<select/>',{class:"node-input-template-subject"})
                    .css({
                        "width": "100%",
                        "height": "36px",
                        "padding": "6px",
                        "font-size": "14px"
                    });
                
                // Create predicate dropdown
                var predicateField = $('<select/>',{class:"node-input-template-predicate"})
                    .css({
                        "width": "100%",
                        "height": "36px",
                        "padding": "6px",
                        "font-size": "14px"
                    });
                
                // Create object dropdown
                var objectField = $('<select/>',{class:"node-input-template-object"})
                    .css({
                        "width": "100%",
                        "height": "36px",
                        "padding": "6px",
                        "font-size": "14px"
                    });

                // Initialize dropdowns with default and custom options
                subjectField.append($('<option value="">-- Subject --</option>'));
                subjectField.append($('<option value="custom">+ Custom Subject</option>'));
                
                predicateField.append($('<option value="">-- Predicate --</option>'));
                predicateField.append($('<option value="custom">+ Custom Predicate</option>'));
                
                objectField.append($('<option value="">-- Object --</option>'));
                objectField.append($('<option value="custom">+ Custom Object</option>'));

                // Add custom input handlers
                subjectField.on('change', function() {
                    var row = $(this).closest('.template-row');
                    var selectedSubject = $(this).val();
                    var predicateSelect = row.find('.node-input-template-predicate');
                    var objectSelect = row.find('.node-input-template-object');
                    
                    if (selectedSubject === 'custom') {
                        $(this).hide();
                        customSubjectInput.show().focus();
                        return;
                    }
                    
                    // Clear and reset predicate dropdown
                    predicateSelect.empty();
                    predicateSelect.append($('<option value="">-- Predicate --</option>'));
                    predicateSelect.append($('<option value="custom">+ Custom Predicate</option>'));
                    
                    if (selectedSubject && window.schemaData) {
                        // Filter predicates based on selected subject
                        var validPredicates = Object.keys(window.schemaData.predicates)
                            .filter(function(predicate) {
                                var predicateInfo = window.schemaData.predicates[predicate];
                                var subjectTypes = Array.isArray(predicateInfo.subject_type) ? 
                                    predicateInfo.subject_type : [predicateInfo.subject_type];
                                return subjectTypes.includes(selectedSubject);
                            })
                            .sort();
                        
                        validPredicates.forEach(function(predicate) {
                            predicateSelect.append($('<option/>').text(predicate).val(predicate));
                        });
                    }
                    
                    // Clear object dropdown when subject changes
                    objectSelect.empty();
                    objectSelect.append($('<option value="">-- Object --</option>'));
                    objectSelect.append($('<option value="custom">+ Custom Object</option>'));
                    
                    // Refresh select2
                    if ($.fn.select2) {
                        predicateSelect.select2("destroy").select2({
                                placeholder: "Select...",
                                allowClear: true,
                                tags: true,
                                width: '100%'
                            });
                        objectSelect.select2("destroy").select2({
                            placeholder: "Select...",
                            allowClear: true,
                            tags: true,
                            width: '100%'
                    });
                }
            });
            
                predicateField.on('change', function() {
                    var row = $(this).closest('.template-row');
                    var selectedPredicate = $(this).val();
                    var objectSelect = row.find('.node-input-template-object');
                    
                    if (selectedPredicate === 'custom') {
                        $(this).hide();
                        customPredicateInput.show().focus();
                        return;
                    }
                    
                    // Clear and reset object dropdown
                    objectSelect.empty();
                    objectSelect.append($('<option value="">-- Object --</option>'));
                    objectSelect.append($('<option value="custom">+ Custom Object</option>'));
                    
                    if (selectedPredicate && window.schemaData && window.schemaData.predicates[selectedPredicate]) {
                        var predicateInfo = window.schemaData.predicates[selectedPredicate];
                        var objectType = predicateInfo.object_type;
                        
                        // If object_type is an array, add all possible entity types
                        if (Array.isArray(objectType)) {
                            objectType.forEach(function(type) {
                                objectSelect.append($('<option/>').text(type).val(type));
                            });
                        } 
                        // If it's a single type, add just that entity type
                        else if (objectType) {
                            objectSelect.append($('<option/>').text(objectType).val(objectType));
                        }
                    }
                    
                    // Refresh select2
                    if ($.fn.select2) {
                        objectSelect.select2("destroy").select2({
                            placeholder: "Select...",
                            allowClear: true,
                            tags: true,
                            width: '100%'
                        });
                    }
                });

                objectField.on('change', function() {
                    if ($(this).val() === 'custom') {
                        $(this).hide();
                        customObjectInput.show().focus();
                    }
                });

                // Add handlers to switch back from custom input to dropdown
                function setupCustomInputHandler(input, select, wrapper) {
                    input.on('blur', function() {
                        var customValue = $(this).val().trim();
                        if (customValue === '') {
                            $(this).hide();
                            select.show().val('').trigger('change');
                        }
                    });

                    input.on('keydown', function(e) {
                        if (e.key === 'Escape') {
                            $(this).hide();
                            select.show().val('').trigger('change');
                        }
                    });

                    // Add a small "x" button to return to dropdown
                    var returnToDropdown = $('<a href="#" class="return-to-dropdown">&times;</a>').css({
                        "position": "absolute",
                        "right": "8px",
                        "top": "50%",
                        "transform": "translateY(-50%)",
                        "text-decoration": "none",
                        "color": "#666",
                        "font-size": "16px",
                        "display": "none"
                    });

                    wrapper.append(returnToDropdown);

                    input.on('focus', function() {
                        returnToDropdown.show();
                    });

                    returnToDropdown.on('click', function(e) {
                        e.preventDefault();
                        input.hide();
                        returnToDropdown.hide();
                        select.show().val('').trigger('change');
                    });
                }

                setupCustomInputHandler(customSubjectInput, subjectField, subjectWrapper);
                setupCustomInputHandler(customPredicateInput, predicateField, predicateWrapper);
                setupCustomInputHandler(customObjectInput, objectField, objectWrapper);

                // Populate initial values if schema data is available
                if (window.schemaData) {
                    // Populate subjects (entity types)
                    var entityTypes = Object.keys(window.schemaData.entity_types || {}).sort();
                    entityTypes.forEach(function(entity) {
                        var option = $('<option/>').text(entity).val(entity);
                        if (template.subject === entity) {
                            option.attr('selected', 'selected');
                        }
                        subjectField.append(option);
                    });

                    // If we have a saved subject that's not in the schema, treat it as custom
                    if (template.subject && !entityTypes.includes(template.subject)) {
                        subjectField.val('custom').hide();
                        customSubjectInput.val(template.subject).show();
                    }

                    // Handle saved predicate and object similarly
                    if (template.predicate) {
                        if (window.schemaData.predicates[template.predicate]) {
                            predicateField.append($('<option/>').text(template.predicate).val(template.predicate).attr('selected', 'selected'));
                        } else {
                            predicateField.val('custom').hide();
                            customPredicateInput.val(template.predicate).show();
                        }
                    }

                    if (template.object) {
                        var validObjects = [];
                        if (template.predicate && window.schemaData.predicates[template.predicate]) {
                            var objectType = window.schemaData.predicates[template.predicate].object_type;
                            validObjects = Array.isArray(objectType) ? objectType : [objectType];
                        }
                        
                        if (validObjects.includes(template.object)) {
                            objectField.append($('<option/>').text(template.object).val(template.object).attr('selected', 'selected'));
                        } else {
                            objectField.val('custom').hide();
                            customObjectInput.val(template.object).show();
                        }
                    }
                }

                // Add all elements to their wrappers
                subjectWrapper.append(subjectField).append(customSubjectInput);
                predicateWrapper.append(predicateField).append(customPredicateInput);
                objectWrapper.append(objectField).append(customObjectInput);

                // Storage checkbox container
                var storageContainer = $('<div/>').css({
                    "display": "flex",
                    "align-items": "center",
                    "margin-right": "8px",
                    "white-space": "nowrap"
                });
                
                // Use rowIndex for unique ID
                var uniqueCheckboxId = "storage-" + node.id + "-" + rowIndex;
                
                var storageCheckbox = $('<input/>',{
                    class:"node-input-template-storage",
                    type:"checkbox",
                    id: uniqueCheckboxId
                })
                .css({
                    "margin": "0 5px 0 0"
                })
                .prop("checked", template.enableStorage === true);
                
                var storageLabel = $('<label/>')
                    .attr("for", uniqueCheckboxId)
                    .text("Store")
                    .css({
                        "font-weight": "normal",
                        "font-size": "14px",
                        "margin": "0",
                        "cursor": "pointer"
                    });
                
                // Delete button
                var deleteButton = $('<a/>',{href:"#", class:"editor-button editor-button-small"})
                    .append($('<i/>',{class:"fa fa-trash"}))
                    .css({
                        "padding": "6px 8px",
                        "margin-left": "auto"
                    })
                    .click(function(e) {
                        e.preventDefault();
                        container.remove();
                    });
                
                // Assemble the row
                storageContainer.append(storageCheckbox).append(storageLabel);
                container.append(subjectWrapper)
                         .append(predicateWrapper)
                         .append(objectWrapper)
                         .append(storageContainer)
                         .append(deleteButton);
                
                // Add to template container
                $("#node-input-template-container").append(container);
                
                // Initialize select2 for all dropdowns
                if ($.fn.select2) {
                    var select2Config = {
                        placeholder: "Select...",
                        allowClear: true,
                        tags: true,
                        width: '100%'
                    };
                    
                    subjectField.select2(select2Config);
                    predicateField.select2(select2Config);
                    objectField.select2(select2Config);
                }
            }
            
            // Initialize function editors
            var functionContainer = $("#node-input-function-container");
            functionContainer.empty();
            var functionEditors = {};
            var functionCounter = 0;
            
            // Check if node has been saved before
            if (!node.hasBeenSaved && window.doxigenData && window.doxigenData.tools) {
                // Node has never been saved - load from doxigenData
                console.log("Loading default tools from doxigenData");
                for (var i = 0; i < window.doxigenData.tools.length; i++) {
                    addFunctionRow(window.doxigenData.tools[i], functionCounter++);
                }
            } else if (node.functions && node.functions.length) {
                // Node has been saved before - load saved functions
                console.log("Loading saved tools from node configuration");
                for (var i = 0; i < node.functions.length; i++) {
                    addFunctionRow(node.functions[i], functionCounter++);
                }
            } else {
                // No saved functions and no doxigenData - add default empty row
                console.log("Adding default empty tool");
                addFunctionRow({
                    name: "Tool 1",
                    code: ""
                }, functionCounter++);
            }
            
            // Setup add function button
            $("#node-input-add-function").click(function() {
                addFunctionRow({
                    name: "Tool " + (functionCounter + 1),
                    code: ""
                }, functionCounter++);
            });
            
            function addFunctionRow(functionDef, id) {
                var container = $('<div/>',{class:"form-row function-row", id:"function-row-" + id});
                
                // Function name
                var headerRow = $('<div/>',{class:"form-row function-header-row"});
                var functionLabel = $('<span/>').text("Tool Name: ").css({"margin-right":"10px"});
                var nameField = $('<input/>',{
                    class:"node-input-function-name",
                    type:"text",
                    id: "node-input-function-name-" + id
                })
                .css({"width":"50%", "margin-right":"10px", "height": "34px", "padding": "4px 8px"})
                .attr("placeholder", "Tool Name")
                .val(functionDef.name || "");
                
                // Delete button
                var deleteButton = $('<a/>',{href:"#", class:"editor-button editor-button-small"})
                    .append($('<i/>',{class:"fa fa-trash fa-lg"}))
                    .css({
                        "padding": "6px 10px"
                    })
                    .click(function(e) {
                        e.preventDefault();
                        
                        // Remove the editor from the registry
                        delete functionEditors["function-editor-" + id];
                        
                        // Remove the container and its separator
                        container.next("hr").remove();
                        container.remove();
                    });
                
                headerRow.append(functionLabel)
                         .append(nameField)
                         .append(deleteButton);
                
                // Code editor
                var editorRow = $('<div/>',{class:"form-row", style:"position:relative"});
                var editorContainer = $('<div/>',{
                    style:"width: 100%; height: 300px; min-height:200px;",
                    class:"node-text-editor",
                    id: "node-input-function-editor-" + id
                });
                
                editorRow.append(editorContainer);
                
                container.append(headerRow)
                         .append(editorRow);
                
                if (functionContainer.children().length > 0) {
                    functionContainer.append($('<hr/>',{style:"margin-top:20px; margin-bottom:20px;"}));
                }
                         
                functionContainer.append(container);
                
                var editor = RED.editor.createEditor({
                    id: "node-input-function-editor-" + id,
                    mode: "ace/mode/python",
                    value: functionDef.code || ""
                });
                
                functionEditors["function-editor-" + id] = editor;
            }
            
            this.functionEditors = functionEditors;

            // Function to update the preview display
            function updatePreview() {
                
                
                
                nodeOutputs.forEach(function(outputStr, index) {
                    var pre = $('<pre>').text(outputStr).css({
                        "margin-bottom": "10px",
                        "padding-bottom": "10px",
                        "border-bottom": index < nodeOutputs.length - 1 ? "1px solid #eee" : "none",
                        "word-wrap": "break-word",
                        "white-space": "pre-wrap"
                    });
                    outputPreviewContainer.append(pre);
                });
            }
        },
        oneditsave: function() {
            var node = this;
            
            // Set hasBeenSaved to true
            node.hasBeenSaved = true;
            
            // Save templates
            var templates = [];
            
            $(".template-row").each(function() {
                var row = $(this);
                var subject = row.find(".node-input-template-subject").is(":visible") ? 
                    row.find(".node-input-template-subject").val() :
                    row.find(".custom-input:first").val();
                    
                var predicate = row.find(".node-input-template-predicate").is(":visible") ?
                    row.find(".node-input-template-predicate").val() :
                    row.find(".custom-input:eq(1)").val();
                    
                var object = row.find(".node-input-template-object").is(":visible") ?
                    row.find(".node-input-template-object").val() :
                    row.find(".custom-input:eq(2)").val();
                    
                var enableStorage = row.find(".node-input-template-storage").is(":checked");
                
                if (subject && predicate && object) {
                    // If value is 'custom', use the custom input value instead
                    if (subject === 'custom') subject = row.find(".custom-input:first").val();
                    if (predicate === 'custom') predicate = row.find(".custom-input:eq(1)").val();
                    if (object === 'custom') object = row.find(".custom-input:eq(2)").val();
                    
                    templates.push({
                        subject: subject,
                        predicate: predicate,
                        object: object,
                        enableStorage: enableStorage
                    });
                }
            });
            
            node.templates = templates;
            
            // Save functions
            var functions = [];
            $(".function-row").each(function() {
                var id = $(this).attr("id").replace("function-row-", "");
                var name = $(this).find(".node-input-function-name").val() || "Function";
                var editor = node.functionEditors["function-editor-" + id];
                var code = editor ? editor.getValue() : "";
                
                functions.push({
                    name: name,
                    code: code
                });
            });
            
            node.functions = functions;
            
            if (this._cleanUpComms) {
                this._cleanUpComms();
            }
        },
        oneditcancel: function() {
            // Mark that dialog is closed
            if (this._config_dialog_open) {
                this._config_dialog_open = false;
            }
            
            if (this.functionEditors) {
                for (var id in this.functionEditors) {
                    if (this.functionEditors.hasOwnProperty(id)) {
                        this.functionEditors[id].destroy();
                    }
                }
            }
            
            $('#unit-node-dialog-styles').remove();
            
            if (this._cleanUpComms) {
                this._cleanUpComms();
            }
        },
        oneditdelete: function() {
            // Mark that dialog is closed
            if (this._config_dialog_open) {
                this._config_dialog_open = false;
            }
            
            if (this.functionEditors) {
                for (var id in this.functionEditors) {
                    if (this.functionEditors.hasOwnProperty(id)) {
                        this.functionEditors[id].destroy();
                    }
                }
            }
            
            $('#unit-node-dialog-styles').remove();
            
            if (this._cleanUpComms) {
                this._cleanUpComms();
            }
        },
        _cleanUpComms: function() {
            console.log("Cleaning up WebSocket subscription");
            if (this._outputMessageHandler) {
                RED.comms.unsubscribe("unit-node/" + this.id, this._outputMessageHandler);
                this._outputMessageHandler = null;
            }
        }
    });

    $(document).on('schema-data-loaded', function(event, data) {
        console.log("Received schema-data-loaded event with data:", data);
        if (data) {
            window.schemaData = data;
            
            // Trigger update for all existing rows
            $(".node-input-template-subject").each(function() {
                $(this).trigger('change');
            });
        }
    });

</script>

<script type="text/html" data-template-name = "unit-node">
    <!-- Main container for two-column layout -->
    <div id="unit-node-editor-container" style="display: flex; width: 100%; height: 100%;">

        <!-- Left Column (70%): Existing Properties -->
        <div id="unit-node-properties-column" style="flex: 0 0 70%; padding-right: 15px; box-sizing: border-box; overflow-y: auto;">

            <div class="form-row">
                <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
                <input type="text" id="node-input-name" placeholder="Name">
            </div>

            <div class="form-row">
                <label for="node-input-prompt-container"><i class="fa fa-comment"></i> Prompt</label>
                <div style="display: inline-block; position: relative; width: 70%; height: 34px;">
                    <div style="position: absolute; left: 0; right: 0; top: 0; bottom: 0; display: flex; align-items: center; overflow: hidden; border: 1px solid #ccc; border-radius: 4px; padding: 0 8px; cursor: pointer;" id="node-input-prompt-container">
                        <div style="text-overflow: ellipsis; overflow: hidden; white-space: nowrap;" id="node-input-prompt-preview"></div>
                        <input type="hidden" id="node-input-prompt">
                    </div>
                </div>
            </div>

            <div class="form-row">
                <label for="node-input-objective-container"><i class="fa fa-bullseye"></i> Objective</label>
                <div style="display: inline-block; position: relative; width: 70%; height: 34px;">
                    <div style="position: absolute; left: 0; right: 0; top: 0; bottom: 0; display: flex; align-items: center; overflow: hidden; border: 1px solid #ccc; border-radius: 4px; padding: 0 8px; cursor: pointer;" id="node-input-objective-container">
                        <div style="text-overflow: ellipsis; overflow: hidden; white-space: nowrap;" id="node-input-objective-preview"></div>
                        <input type="hidden" id="node-input-objective">
                    </div>
                </div>
            </div>

            <!-- MQTT Section - Only Topic and QoS -->
            <div class="form-row">
                <label for="node-input-topic"><i class="fa fa-tasks"></i> MQTT Topic</label>
                <input type="text" id="node-input-topic" placeholder="topic">
            </div>
            <div class="form-row">
                <label for="node-input-qos"><i class="fa fa-empire"></i> QoS</label>
                <select id="node-input-qos" style="width:125px !important">
                    <option value="0">0</option>
                    <option value="1">1</option>
                    <option value="2">2</option>
                </select>
            </div>

            <!-- Knowledge Graph Triplet Templates Section -->
            <!-- API Endpoint (Common for all templates) -->
            <div class="form-row">
                <label for="node-input-apiEndpoint"><i class="fa fa-link"></i> API Endpoint for unit-nodes</label>
                <input type="text" id="node-input-apiEndpoint" placeholder="http://your-api-endpoint">
            </div>

            <!-- Triplet templates section with header and add button -->
            <div class="form-row">
                <label><i class="fa fa-list"></i> Triplet Templates</label>
                <a href="#" class="editor-button editor-button-small" id="node-input-add-template" style="margin-top:4px; padding: 4px 10px;">
                    <i class="fa fa-plus"></i> Add
                </a>
            </div>

            <!-- Compact template header row -->
            <div class="form-row" style="margin-top:10px; margin-bottom:5px; padding: 0 8px;">
                <div style="display: flex; width: 100%; padding-left: 100px; box-sizing: border-box;">
                    <div style="flex: 1; margin-right: 8px; font-weight: bold; font-size: 14px;">Subject</div>
                    <div style="flex: 1; margin-right: 8px; font-weight: bold; font-size: 14px;">Predicate</div>
                    <div style="flex: 1; margin-right: 8px; font-weight: bold; font-size: 14px;">Object</div>
                    <div style="margin-right: 8px; font-weight: bold; font-size: 14px;">Store</div>
                    <div style="width: 40px;"></div>
                </div>
            </div>

            <!-- Template container with compact styling -->
            <div style="padding-left: 100px; min-height: 120px; margin-bottom: 15px;" id="node-input-template-container">
                <!-- Template rows will be added here by JS -->
            </div>

            <!-- Custom Functions Section -->
            <div class="form-row" style="margin-top:20px; margin-bottom:0;">
                <label><i class="fa fa-code"></i> Tools</label>
            </div>
            <div id="node-input-function-container">
                <!-- Function editors will be added here by JS -->
            </div>
            <div class="form-row" style="margin-top:15px;">
                <div style="display: flex; justify-content: center; width: 100%;">
                    <a href="#" class="editor-button" id="node-input-add-function" style="padding: 8px 15px; font-size: 14px;">
                        <i class="fa fa-plus"></i> Add Tool
                    </a>
                </div>
            </div>

            <!-- Moved Payload field here, after the Tools section -->
            <div class="form-row" style="margin-top:20px;">
                <label for="node-input-payload"><i class="fa fa-envelope"></i> Payload</label>
                <input type="text" id="node-input-payload" placeholder="Default payload">
            </div>

        </div> <!-- End Left Column -->

        <!-- Right Column (30%): Output Area -->
        <!-- Added height: 100% and flex-direction column for proper layout -->
        <div id="unit-node-output-column" style="flex: 1; padding-left: 5px; border-left: 1px solid #ccc;">
            <div id="node-output-preview" style="height: 100%; overflow-y: auto; font-family: monospace; font-size: 12px;">
                <!-- Output content will be populated here by JS -->
            </div>
        </div> <!-- End Right Column -->

    </div> <!-- End Main Container -->
</script>

<script type="text/html" data-help-name = "unit-node">
    <p>A node that processes input messages and creates knowledge graph triplets with customizable templates.</p>
    
    <h3>Features</h3>
    <ul>
        <li><b>Input Processing:</b> Processes incoming flow messages, applying the configured default payload.</li>
        <li><b>MQTT Integration:</b> Always connects to MQTT topics for message input and output.</li>
        <li><b>Knowledge Graph Templates:</b> Define triplets in subject-predicate-object format with dynamic values from message paths.</li>
        <li><b>Individual Storage Options:</b> Each triplet can be individually configured for storage using the common API endpoint.</li>
        <li><b>Tools:</b> Add multiple Python function tools to process messages with full access to Node-RED context variables.</li>
        <li><b>Automatic Debug Logging:</b> Always logs messages to the Node-RED debug panel without needing a separate debug node.</li>
    </ul>
    
    <h3>Triplet Format</h3>
    <p>Each triplet template consists of:</p>
    <ul>
        <li><b>Subject:</b> The entity that the triplet refers to (select from dropdown with predefined values)</li>
        <li><b>Predicate:</b> The relationship between subject and object (select from dropdown with predefined values)</li>
        <li><b>Object:</b> The object value or a path to extract from the message (e.g., "msg.payload.name")</li>
        <li><b>Store:</b> Whether to store this triplet via the API endpoint</li>
    </ul>
    
    <h3>Dynamic Values</h3>
    <p>You can use paths like "msg.payload.value" or "msg.topic" in the object field to dynamically extract values from incoming messages.</p>
    
    <h3>Subject and Predicate Options</h3>
    <p>The subject and predicate dropdowns are populated with predefined entities and relations.</p>
    
    <h3>Storage</h3>
    <p>Triplets marked for storage will be sent to the configured API endpoint. All triplets use the same endpoint, but you can choose which ones to store individually.</p>
    
    <h3>Tools</h3>
    <p>The Tools section allows you to define Python function tools to process messages with full access to Node-RED context variables.</p>
    <ul>
        <li><b>Important:</b> These Python functions are <em>not</em> executed by Node-RED.</li>
        <li>They serve as documentation and code examples only.</li>
        <li>The node will store these definitions and add their names to the outgoing messages as a reference.</li>
        <li>No actual Python code execution occurs within Node-RED.</li>
    </ul>
    <p>Tool functions use Python Doxygen-style documentation for standardized reference.</p>
    <p>Example Python tool documentation:</p>
    <pre>"""
Calculate the greatest common divisor of two numbers

Parameters
----------
a : int
    First integer
b : int
    Second integer

Returns
-------
int
    Greatest common divisor of a and b
"""
def gcd(a, b):
    """Compute the greatest common divisor of a and b"""
    while b:
        a, b = b, a % b
    return a

# Example usage
print(gcd(48, 18))  # 6
print(gcd(101, 103))  # 1</pre>
    
    <h3>Automatic Debug Logging</h3>
    <p>This node automatically logs all output messages to the Node-RED debug panel. No debug node is required in your flow.</p>
    <ul>
        <li>All messages processed by this node appear in the debug sidebar</li>
        <li>Messages show the full payload and all properties</li>
        <li>This happens automatically without needing to add a debug node to your flow</li>
    </ul>
    
    <h3>Example</h3>
    <p>For incoming message: <code>{"payload": {"name": "John", "symptom": "Headache"}}</code></p>
    <p>With templates:</p>
    <ul>
        <li>subject: "Patient", predicate: "has_appointment_with", object: "msg.payload.name"</li>
        <li>subject: "Patient", predicate: "has_symptom", object: "msg.payload.symptom"</li>
    </ul>
    <p>Produces triplets:</p>
    <ul>
        <li>(Patient, has_appointment_with, "John")</li>
        <li>(Patient, has_symptom, "Headache")</li>
    </ul>
</script>