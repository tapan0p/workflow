<script type="text/javascript">
    // Create a global object to store handlers for different node instances
    var unitNodeHandlers = {};
    
    RED.events.on("editor:open", function(node) {
        if (node.type === "unit-node") {
            if (!$('#unit-node-dialog-styles').length) {
                $('head').append(
                    '<style id="unit-node-dialog-styles">' +
                    '.red-ui-editor .red-ui-tray-content { width: 850px !important; }' +
                    '.red-ui-editor .red-ui-tray-content .red-ui-tray-content-content { width: 850px !important; }' +
                    '.red-ui-editor .form-row input, .red-ui-editor .form-row select { width: 70%; }' +
                    '.form-row input[type="hidden"] + div.red-ui-typedInput-container { width: 70% !important; }' +
                    '.red-ui-editor-stack { right: calc(100% - 850px) !important; }' +
                    '.red-ui-editor .red-ui-tray-footer { width: 850px; }' +
                    '.template-row .select2-container { width: 100% !important; }' +
                    '.template-row .select2-container .select2-selection { height: 36px !important; }' +
                    '.template-row .select2-container .select2-selection .select2-selection__rendered { line-height: 36px !important; }' +
                    '.template-row .select2-container .select2-selection .select2-selection__arrow { height: 36px !important; }' +
                    '</style>'
                );
            }
        }
    });

    RED.events.on("editor:close", function(node) {
        if (node.type === "unit-node") {
            $('#unit-node-dialog-styles').remove();
        }
    });

    RED.nodes.registerType('unit-node',{
        category: 'custom',
        color: '#a6bbcf',
        defaults:{
            name:{value:""},
            payload:{value:""},
            topic:{value:"", required:true},
            prompt: {value:""},
            objective: {value:""},
            hasBeenSaved: {value: false},
            
            templates: {value:[]},
            
            functions: {value:[]}
        },
        inputs:1,
        outputs:1,
        icon:'bridge.png',
        label:function(){
            return this.name||'unit node';
        },
        labelStyle: function(){
            return this.name?"node_label_italic":"";
        },
        onpaletteadd: function() {
            
            function handleUnitNodeMessage(topic, data) {
                if (data && data.id && data.msg) {
                    var nodeId = data.id;
                    if (!unitNodeHandlers[nodeId]) {
                        unitNodeHandlers[nodeId] = { data: [] };
                    }
                    
                    // Update stored data
                    unitNodeHandlers[nodeId].data = data.msg;
                    
                    // If node is currently being edited, update its UI
                    var activeNode = RED.nodes.node(nodeId);
                    if (activeNode && activeNode._config_dialog_open) {
                        var outputPreviewContainer = $("#node-output-preview");
                        if (outputPreviewContainer.length) {
                            outputPreviewContainer.empty();
                            
                            data.msg.forEach(function(msg, index) {
                                var content = typeof msg === 'object' ? 
                                    JSON.stringify(msg, null, 2) : msg.toString();
                                
                                var pre = $('<pre>').text(content);
                                outputPreviewContainer.append(pre);
                            });
                        }
                    }
                    
                    
                }
            }
            
            // Subscribe to all unit-node history messages
            RED.comms.subscribe("unit_node_history/+", handleUnitNodeMessage);
            
            // Clean up on palette removal
            this.onpaletteremove = function() {
                RED.comms.unsubscribe("unit_node_history/+", handleUnitNodeMessage);
            };
        },
        oneditprepare: function() {
            var node = this;
            var outputPreviewContainer = $("#node-output-preview");
            var templateRowCounter = 0;
            
            // Set marker that this node is being edited
            node._config_dialog_open = true;

            
            
            
            
            // Display any existing data we already have
            if (unitNodeHandlers[this.id] && unitNodeHandlers[this.id].data) {
                var data = unitNodeHandlers[this.id].data;
                outputPreviewContainer.empty();
                
                data.forEach(function(msg, index) {
                    var content = typeof msg === 'object' ? 
                        JSON.stringify(msg, null, 2) : msg.toString();
                    
                    var pre = $('<pre>').text(content).css({
                        "margin-bottom": "10px",
                        "padding-bottom": "10px",
                        "border-bottom": index < data.length - 1 ? "1px solid #eee" : "none",
                        "word-wrap": "break-word",
                        "white-space": "pre-wrap"
                    });
                    outputPreviewContainer.append(pre);
                });
            }
            
            setupDialogEditor("prompt", "Prompt", "Enter the prompt text that will guide the processing");
            
            setupDialogEditor("objective", "Objective", "Define the objective of this processing step");
            
            function setupDialogEditor(fieldName, title, placeholder) {
                var fieldValue = node[fieldName] || "";
                var fieldPreview = fieldValue.length > 0 ? fieldValue : "Click to edit...";
                
                $("#node-input-" + fieldName + "-preview").text(fieldPreview);
                $("#node-input-" + fieldName).val(fieldValue);
                $("#node-input-" + fieldName + "-container").click(function() {
                    var editorDialog = $('<div id="node-input-' + fieldName + '-dialog" class="editor-dialog"></div>')
                        .appendTo("body")
                        .dialog({
                            title: title,
                            modal: true,
                            width: 800,
                            height: window.innerHeight * 0.8,
                            resizable: true,
                            open: function() {
                                var textarea = $('<textarea style="width: 100%; height: calc(100% - 40px); margin-bottom: 10px; resize: none; overflow-y: auto; overflow-x: hidden; white-space: pre-wrap; word-wrap: break-word;"></textarea>')
                                    .val($("#node-input-" + fieldName).val() || "")
                                    .attr("placeholder", placeholder)
                                    .appendTo(this);
                                    
                                var buttonRow = $('<div style="text-align: right;"></div>').appendTo(this);
                                
                                $('<button>Cancel</button>')
                                    .button()
                                    .appendTo(buttonRow)
                                    .click(function() {
                                        $(editorDialog).dialog('close');
                                    });
                                    
                                $('<button>Save</button>')
                                    .button()
                                    .css("margin-left", "10px")
                                    .appendTo(buttonRow)
                                    .click(function() {
                                        var value = textarea.val();
                                        $("#node-input-" + fieldName).val(value);
                                        
                                        var preview = value.length > 0 ? value : "Click to edit...";
                                        if (preview.length > 50) {
                                            preview = preview.substring(0, 47) + "...";
                                        }
                                        $("#node-input-" + fieldName + "-preview").text(preview);
                                        
                                        $(editorDialog).dialog('close');
                                    });
                            },
                            close: function() {
                                $(this).dialog('destroy');
                                $(this).remove();
                            }
                        });
                });
            }
            
            
            
            // Initialize the template container
            initializeTemplates();
                
            function initializeTemplates() {
                var templateContainer = $("#node-input-template-container");
                templateContainer.empty();
                
                // Load templates ONLY if they exist
                if (node.templates && node.templates.length > 0) {
                    for (var i = 0; i < node.templates.length; i++) {
                        addTemplateRow(node.templates[i], templateRowCounter++);
                    }
                }
            }
            
            // Setup add template button
            $("#node-input-add-template").click(function() {
                addTemplateRow({
                    subject: "",
                    predicate: "",
                    object: "",
                    enableStorage: false
                }, templateRowCounter++);
            });
            
            function addTemplateRow(template, rowIndex) {
                // Create a clean, compact row container
                var container = $('<div/>',{class:"form-row template-row"}).css({
                    "margin-bottom": "8px",
                    "position": "relative",
                    "padding": "6px 8px",
                    "background-color": "#f9f9f9",
                    "border-radius": "4px",
                    "display": "flex",
                    "align-items": "center",
                    "flex-wrap": "nowrap"
                });
                
                // Create wrapper divs for each field
                var subjectWrapper = $('<div/>').css({
                    "flex": "1",
                    "margin-right": "8px",
                    "position": "relative"
                });
                
                var predicateWrapper = $('<div/>').css({
                    "flex": "1",
                    "margin-right": "8px",
                    "position": "relative"
                });
                
                var objectWrapper = $('<div/>').css({
                    "flex": "1",
                    "margin-right": "8px",
                    "position": "relative"
                });
                
                // Create subject dropdown
                var subjectField = $('<select/>',{class:"node-input-template-subject"})
                    .css({
                        "width": "100%",
                        "height": "36px",
                        "padding": "6px",
                        "font-size": "14px"
                    });
                
                // Create predicate dropdown
                var predicateField = $('<select/>',{class:"node-input-template-predicate"})
                    .css({
                        "width": "100%",
                        "height": "36px",
                        "padding": "6px",
                        "font-size": "14px"
                    });
                
                // Create object dropdown
                var objectField = $('<select/>',{class:"node-input-template-object"})
                    .css({
                        "width": "100%",
                        "height": "36px",
                        "padding": "6px",
                        "font-size": "14px"
                    });

                // Only default options, no custom
                subjectField.append($('<option value="">-- Subject --</option>'));
                predicateField.append($('<option value="">-- Predicate --</option>'));
                objectField.append($('<option value="">-- Object --</option>'));

                // Populate initial subject values based on predicate definitions
                var validSubjectTypes = [];
                if (window.schemaData && window.schemaData.predicates) {
                    var subjectSet = new Set(); // Use a Set to automatically handle uniqueness
                    Object.values(window.schemaData.predicates).forEach(function(predicateInfo) {
                        if (predicateInfo.subject_type) {
                            if (Array.isArray(predicateInfo.subject_type)) {
                                predicateInfo.subject_type.forEach(type => subjectSet.add(type));
                            } else {
                                subjectSet.add(predicateInfo.subject_type);
                            }
                        }
                    });
                    validSubjectTypes = Array.from(subjectSet).sort(); // Convert Set to sorted array

                    validSubjectTypes.forEach(function(entity) {
                        // Optional: Check if this subject type actually exists in entity_types for validation
                        if (window.schemaData.entity_types && window.schemaData.entity_types[entity]) {
                             var option = $('<option/>').text(entity).val(entity);
                             subjectField.append(option);
                        } else {
                             console.warn("Subject type '" + entity + "' found in predicates but not defined in entity_types.");
                             // Decide if you still want to add it, maybe marked differently?
                             // var option = $('<option/>').text(entity + " (Undefined)").val(entity);
                             // subjectField.append(option);
                        }
                    });

                    // Set initial selected value if valid according to the new list
                    if (template.subject && validSubjectTypes.includes(template.subject)) {
                        subjectField.val(template.subject);
                    } else {
                        template.subject = ""; // Reset if invalid
                    }
                }
                
                // Function to update Predicate options based on Subject
                function updatePredicates() {
                    var selectedSubject = subjectField.val();
                    predicateField.empty().append($('<option value="">-- Predicate --</option>')); // Clear and add default
                    objectField.empty().append($('<option value="">-- Object --</option>')); // Clear object field too

                    if (selectedSubject && window.schemaData && window.schemaData.predicates) {
                        var validPredicates = Object.keys(window.schemaData.predicates)
                            .filter(function(predicate) {
                                var predicateInfo = window.schemaData.predicates[predicate];
                                // Ensure subject_type exists before checking
                                if (!predicateInfo.subject_type) return false;
                                var subjectTypes = Array.isArray(predicateInfo.subject_type) ? predicateInfo.subject_type : [predicateInfo.subject_type];
                                return subjectTypes.includes(selectedSubject);
                            })
                            .sort();
                        
                        validPredicates.forEach(function(predicate) {
                            predicateField.append($('<option/>').text(predicate).val(predicate));
                        });

                        // Re-initialize select2 for predicate and object
                    if ($.fn.select2) {
                            predicateField.select2("destroy").select2({ placeholder: "Select...", allowClear: true, tags: false, width: '100%' });
                            objectField.select2("destroy").select2({ placeholder: "Select...", allowClear: true, tags: false, width: '100%' });
                        }
                    }
                     // Ensure object field is also updated/cleared even if no subject is selected
                     else if ($.fn.select2) {
                        predicateField.select2("destroy").select2({ placeholder: "Select...", allowClear: true, tags: false, width: '100%' });
                        objectField.select2("destroy").select2({ placeholder: "Select...", allowClear: true, tags: false, width: '100%' });
                     }
                }

                // Function to update Object options based on Predicate
                function updateObjects() {
                    var selectedPredicate = predicateField.val();
                    objectField.empty().append($('<option value="">-- Object --</option>')); // Clear and add default
                    
                    if (selectedPredicate && window.schemaData && window.schemaData.predicates[selectedPredicate]) {
                        var predicateInfo = window.schemaData.predicates[selectedPredicate];
                        var objectTypes = predicateInfo.object_type; // Can be string or array

                        if (objectTypes) {
                             if (Array.isArray(objectTypes)) {
                                objectTypes.sort().forEach(function(type) {
                                     // Check if type exists in entity_types before adding
                                     if (window.schemaData.entity_types && window.schemaData.entity_types[type]) {
                                        objectField.append($('<option/>').text(type).val(type));
                                     } else {
                                         // If it's not an entity type, assume it's a literal or path
                                         objectField.append($('<option/>').text(type + " (Value/Path)").val(type));
                                     }
                                });
                            } else {
                                // Single object type
                                if (window.schemaData.entity_types && window.schemaData.entity_types[objectTypes]) {
                                   objectField.append($('<option/>').text(objectTypes).val(objectTypes));
                                } else {
                                    objectField.append($('<option/>').text(objectTypes + " (Value/Path)").val(objectTypes));
                                }
                            }
                             
                        } else {
                             console.warn("No object types found for predicate '" + selectedPredicate + "'");
                        }


                        // Re-initialize select2 for object
                    if ($.fn.select2) {
                            objectField.select2("destroy").select2({ placeholder: "Select...", allowClear: true, tags: false, width: '100%' });
                        }
                    } else {
                         if ($.fn.select2) {
                             objectField.select2("destroy").select2({ placeholder: "Select...", allowClear: true, tags: false, width: '100%' });
                         }
                    }
                }
                
                
                var objectInput = $('<input/>', {type: 'text', class: 'node-input-template-object-path'})
                    .css({
                        "width": "100%",
                        "height": "36px",
                        "padding": "6px",
                        "font-size": "14px",
                        "border": "1px solid #ccc",
                        "border-radius": "4px",
                        "display": "none" // Initially hidden
                    })
                    .attr("placeholder", "e.g., msg.payload.value");

                objectWrapper.append(objectField).append(objectInput); // Add input field to wrapper

                // Populate initial predicate and object values (AFTER subject is set and potentially updated)
                updatePredicates(); // Call after subject population and initial value set
                if (template.predicate) {
                    // Check if the saved predicate is valid for the current subject
                    var isValidPredicate = predicateField.find('option[value="' + template.predicate + '"]').length > 0;
                    if (isValidPredicate) {
                        predicateField.val(template.predicate);
                    } else {
                         template.predicate = ""; // Reset if invalid
                    }
                }

                updateObjects(); // Populate objects based on potentially selected predicate
                if (template.object) {
                    if (template.object.startsWith('msg.')) {
                        objectField.val('msg.'); // Select the path option
                        objectInput.val(template.object).show(); // Show and populate input
                        objectField.hide(); // Hide dropdown
                    } else {
                        // Check if the saved object is valid for the current predicate
                        var isValidObject = objectField.find('option[value="' + template.object + '"]').length > 0;
                        if (isValidObject) {
                            objectField.val(template.object);
                        } else {
                            template.object = ""; // Reset if invalid
                        }
                    }
                }


                // Add change listeners
                subjectField.on('change', function() {
                    updatePredicates();
                    // If a path was previously entered in object input, hide it
                    if (objectInput) {
                         objectInput.hide();
                         objectField.show();
                    }
                });

                predicateField.on('change', function() {
                    updateObjects();
                     // If a path was previously entered in object input, hide it
                    if (objectInput) {
                         objectInput.hide();
                         objectField.show();
                    }
                });
                
                objectField.on('change', function() {
                    if ($(this).val() === 'msg.') {
                        $(this).hide(); // Hide dropdown
                        objectInput.val('msg.').show().focus(); // Show input field
                        } else {
                         objectInput.hide(); // Ensure input is hidden otherwise
                    }
                });

                 // Handle returning from path input
                objectInput.on('blur', function() {
                    if ($(this).val().trim() === '' || $(this).val().trim() === 'msg.') {
                        $(this).hide();
                        objectField.val('').show(); // Show dropdown again
                         if ($.fn.select2) { // Reinitialize select2
                             objectField.select2("destroy").select2({ placeholder: "Select...", allowClear: true, tags: false, width: '100%' });
                         }
                    }
                });
                objectInput.on('keydown', function(e) {
                     if (e.key === 'Escape') {
                        $(this).hide();
                        objectField.val('').show();
                        if ($.fn.select2) {
                            objectField.select2("destroy").select2({ placeholder: "Select...", allowClear: true, tags: false, width: '100%' });
                        }
                     }
                });


                // Add elements to wrappers (Subject and Predicate wrappers only contain dropdowns)
                subjectWrapper.append(subjectField);
                predicateWrapper.append(predicateField);
                // objectWrapper already populated with objectField and objectInput

                // Storage checkbox container
                var storageContainer = $('<div/>').css({
                    "display": "flex",
                    "align-items": "center",
                    "margin-right": "8px",
                    "white-space": "nowrap"
                });
                
                // Use rowIndex for unique ID
                var uniqueCheckboxId = "storage-" + node.id + "-" + rowIndex;
                
                var storageCheckbox = $('<input/>',{
                    class:"node-input-template-storage",
                    type:"checkbox",
                    id: uniqueCheckboxId
                })
                .css({
                    "margin": "0 5px 0 0"
                })
                .prop("checked", template.enableStorage === true);
                
                var storageLabel = $('<label/>')
                    .attr("for", uniqueCheckboxId)
                    .text("Store")
                    .css({
                        "font-weight": "normal",
                        "font-size": "14px",
                        "margin": "0",
                        "cursor": "pointer"
                    });
                
                // Delete button
                var deleteButton = $('<a/>',{href:"#", class:"editor-button editor-button-small"})
                    .append($('<i/>',{class:"fa fa-trash"}))
                    .css({
                        "padding": "6px 8px",
                        "margin-left": "auto"
                    })
                    .click(function(e) {
                        e.preventDefault();
                        container.remove();
                    });
                
                // Assemble the row
                storageContainer.append(storageCheckbox).append(storageLabel);
                container.append(subjectWrapper)
                         .append(predicateWrapper)
                         .append(objectWrapper)
                         .append(storageContainer)
                         .append(deleteButton);
                
                // Add to template container
                $("#node-input-template-container").append(container);
                
                // Initialize select2 for all dropdowns initially
                if ($.fn.select2) {
                    var select2Config = {
                        placeholder: "Select...",
                        allowClear: true,
                        tags: false,
                        width: '100%'
                    };
                    
                    subjectField.select2(select2Config);
                    predicateField.select2(select2Config);
                    objectField.select2(select2Config);
                }
            }
            
            // Initialize function editors
            var functionContainer = $("#node-input-function-container");
            functionContainer.empty();
            var functionEditors = {};
            var functionCounter = 0;
            
            // Load doxigen data for tools dropdown
            if (!window.doxigenData) {
                $.getJSON('data/custom_doxigen_data.json', function(data) {
                    window.doxigenData = data;
                    initializeToolsSelection();
                }).fail(function(jqXHR, textStatus, errorThrown) {
                    console.error("Failed to load doxigen data:", textStatus, errorThrown);
                    // Add an empty row even if we failed to load
                    initializeToolsSelection();
                });
            } else {
                initializeToolsSelection();
            }
            
            function initializeToolsSelection() {
                // Create the multi-select dropdown container
                var toolSelectionContainer = $('<div/>', {class: "form-row", id: "node-input-tools-selection-container"})
                    .css({
                        "margin-bottom": "20px",
                        "padding": "15px",
                        "background-color": "#f9f9f9",
                        "border-radius": "4px"
                    });
                
                // Create title and description
                var titleRow = $('<div/>')
                    .css({
                        "margin-bottom": "10px",
                        "font-weight": "bold",
                        "font-size": "14px"
                    })
                    .text("Available Tools");
                
                var descriptionRow = $('<div/>')
                    .css({
                        "margin-bottom": "15px",
                        "font-size": "13px",
                        "color": "#666"
                    })
                    .text("Select the tools you want to include in this node from the dropdown below:");
                
                // Create the tools dropdown
                var toolsDropdownContainer = $('<div/>')
                    .css({
                        "margin-bottom": "15px"
                    });
                
                var toolsDropdown = $('<select/>', {
                    id: "node-input-tools-dropdown",
                    multiple: "multiple"
                }).css({
                    "width": "100%",
                    "min-height": "200px"
                });
                
                // Populate dropdown with available tools
                if (window.doxigenData && window.doxigenData.tools) {
                    window.doxigenData.tools.forEach(function(tool) {
                        if (tool.name && tool.code) {
                            var option = $('<option/>')
                                .val(JSON.stringify({name: tool.name, code: tool.code}))
                                .text(tool.name);
                            toolsDropdown.append(option);
                        }
                    });
                }
                
                toolsDropdownContainer.append(toolsDropdown);
                
                // Add helper text for selecting multiple items
                var helpText = $('<div/>')
                    .css({
                        "margin-top": "5px",
                        "font-style": "italic",
                        "color": "#666",
                        "font-size": "12px"
                    })
                    .html("<strong>Tip:</strong> Hold Ctrl (or Cmd on Mac) while clicking to select multiple tools. You can also use Shift to select a range.");
                    
                toolsDropdownContainer.append(helpText);
                
                // Create the selected tools display section
                var selectedToolsContainer = $('<div/>', {id: "node-input-selected-tools-container"})
                    .css({
                        "margin-top": "20px"
                    });
                
                var selectedToolsTitle = $('<div/>')
                    .css({
                        "display": "flex",
                        "align-items": "center",
                        "margin-bottom": "10px"
                    });
                    
                var titleText = $('<span/>')
                    .css({
                        "font-weight": "bold",
                        "font-size": "14px",
                        "flex": "1"
                    })
                    .text("Selected Tools");
                    
                var selectedCount = $('<span/>', {id: "node-input-selected-tools-count"})
                    .css({
                        "background-color": "#9cc669",
                        "color": "white",
                        "padding": "2px 8px",
                        "border-radius": "10px",
                        "font-size": "12px",
                        "margin-left": "8px"
                    })
                    .text("0 selected");
                    
                titleText.append(selectedCount);
                selectedToolsTitle.append(titleText);
                
                var selectedToolsList = $('<div/>', {id: "node-input-selected-tools-list"})
                    .css({
                        "max-height": "300px",
                        "overflow-y": "auto",
                        "border": "1px solid #ddd",
                        "border-radius": "4px",
                        "padding": "10px",
                        "background-color": "#fff"
                    });
                
                selectedToolsContainer.append(selectedToolsTitle).append(selectedToolsList);
                
                // Assemble the container
                toolSelectionContainer
                    .append(titleRow)
                    .append(descriptionRow)
                    .append(toolsDropdownContainer)
                    .append(selectedToolsContainer);
                
                // Add to function container
                functionContainer.append(toolSelectionContainer);
                
                // Initialize Select2 for the dropdown
                if ($.fn.select2) {
                    toolsDropdown.select2({
                        placeholder: "Select tools to include...",
                        allowClear: true,
                        width: '100%',
                        multiple: true,
                        closeOnSelect: false,
                        templateResult: formatToolOption,
                        templateSelection: formatToolSelection
                    });
                    
                    // Force the dropdown to stay open when an option is selected
                    toolsDropdown.on("select2:select", function(evt) {
                        var element = evt.params.data.element;
                        var $element = $(element);
                        
                        $element.detach();
                        $(this).append($element);
                        $(this).trigger("change");
                    });
                }
                
                // Format the dropdown options to show more details
                function formatToolOption(tool) {
                    if (!tool.id) return tool.text;
                    
                    try {
                        var toolData = JSON.parse(tool.id);
                        var $option = $(
                            '<div class="tool-option">' +
                            '<div class="tool-name">' + toolData.name + '</div>' +
                            '<div class="tool-description">' + extractDescription(toolData.code) + '</div>' +
                            '</div>'
                        );
                        return $option;
                    } catch (e) {
                        return tool.text;
                    }
                }
                
                // Format the selected items
                function formatToolSelection(tool) {
                    if (!tool.id) return tool.text;
                    
                    try {
                        var toolData = JSON.parse(tool.id);
                        return toolData.name;
                    } catch (e) {
                        return tool.text;
                    }
                }
                
                // Extract a short description from the tool code
                function extractDescription(code) {
                    if (!code) return "";
                    
                    // Try to extract a docstring
                    var docStringMatch = code.match(/['"]['"](['"]|[^'"]*?)['"](['"]|[^'"]*?)['"](['"])?/);
                    if (docStringMatch) {
                        var docString = docStringMatch[0].replace(/['"](['"]){2,}/g, '');
                        // Just take the first line as a short description
                        var firstLine = docString.split('\n')[0];
                        return firstLine || "No description available";
                    }
                    
                    // If no docstring, extract the first function name
                    var funcMatch = code.match(/def\s+([a-zA-Z_][a-zA-Z0-9_]*)\s*\(/);
                    if (funcMatch) {
                        return "Function: " + funcMatch[1];
                    }
                    
                    return "No description available";
                }
                
                // Handle changing selection
                toolsDropdown.on('change', function(e) {
                    updateSelectedToolsList();
                });
                
                // Function to update the selected tools list
                function updateSelectedToolsList() {
                    var selectedToolsList = $('#node-input-selected-tools-list');
                    selectedToolsList.empty();
                    
                    var selectedTools = toolsDropdown.val() || [];
                    
                    // Update the count badge
                    $('#node-input-selected-tools-count').text(selectedTools.length + " selected");
                    
                    if (selectedTools.length === 0) {
                        selectedToolsList.append('<div class="no-tools-selected">No tools selected</div>');
                        return;
                    }
                    
                    // Create a list of selected tools with delete buttons
                    selectedTools.forEach(function(toolJson, index) {
                        try {
                            var tool = JSON.parse(toolJson);
                            
                            var toolItem = $('<div/>', {class: "selected-tool-item", 'data-index': index})
                                .css({
                                    "display": "flex",
                                    "align-items": "center",
                                    "padding": "8px",
                                    "border-bottom": "1px solid #eee",
                                    "background-color": "#f8f8f8",
                                    "margin-bottom": "5px",
                                    "border-radius": "3px"
                                });
                            
                            var toolName = $('<div/>', {class: "selected-tool-name"})
                                .css({
                                    "flex": "1",
                                    "font-weight": "bold"
                                })
                                .text(tool.name);
                            
                            var removeButton = $('<a/>', {href: "#", class: "remove-tool-button"})
                                .css({
                                    "color": "#999",
                                    "margin-left": "8px",
                                    "font-size": "16px",
                                    "text-decoration": "none"
                                })
                                .html('<i class="fa fa-times"></i>')
                                .attr('title', 'Remove this tool')
                    .click(function(e) {
                        e.preventDefault();
                        
                                    // Get the current selections
                                    var currentSelections = toolsDropdown.val() || [];
                                    
                                    // Remove this item
                                    var newSelections = currentSelections.filter(function(item, idx) {
                                        return idx !== index;
                                    });
                                    
                                    // Update the dropdown
                                    toolsDropdown.val(newSelections).trigger('change');
                                });
                            
                            toolItem.append(toolName).append(removeButton);
                            selectedToolsList.append(toolItem);
                        } catch (e) {
                            console.error("Error parsing tool JSON:", e);
                        }
                    });
                }
                
                // Load previously selected tools
                if (node.functions && node.functions.length) {
                    var selectedValues = [];
                    
                    // For each function in the node, find matching tool in the dropdown
                    node.functions.forEach(function(func) {
                        if (func.name && func.code) {
                            // Look for exact match in doxigen data
                            var found = false;
                            
                            if (window.doxigenData && window.doxigenData.tools) {
                                window.doxigenData.tools.forEach(function(tool) {
                                    if (tool.name === func.name && tool.code === func.code) {
                                        selectedValues.push(JSON.stringify({name: tool.name, code: tool.code}));
                                        found = true;
                                    }
                                });
                            }
                            
                            // If not found, add it as a custom option
                            if (!found) {
                                var option = $('<option/>')
                                    .val(JSON.stringify({name: func.name, code: func.code}))
                                    .text(func.name + " (Custom)")
                                    .prop("selected", true);
                                toolsDropdown.append(option);
                                selectedValues.push(JSON.stringify({name: func.name, code: func.code}));
                            }
                        }
                    });
                    
                    // Set the values and update the display
                    toolsDropdown.val(selectedValues).trigger('change');
                }
            }
            
            this.functionEditors = functionEditors;

            // Function to update the preview display
            function updatePreview() {
                
                
                
                nodeOutputs.forEach(function(outputStr, index) {
                    var pre = $('<pre>').text(outputStr).css({
                        "margin-bottom": "10px",
                        "padding-bottom": "10px",
                        "border-bottom": index < nodeOutputs.length - 1 ? "1px solid #eee" : "none",
                        "word-wrap": "break-word",
                        "white-space": "pre-wrap"
                    });
                    outputPreviewContainer.append(pre);
                });
            }
        },
        oneditsave: function() {
            var node = this;
            
            // Set hasBeenSaved to true
            node.hasBeenSaved = true;
            
            // Save templates
            var templates = [];
            
            $(".template-row").each(function() {
                var row = $(this);
                var subject = row.find(".node-input-template-subject").val();
                var predicate = row.find(".node-input-template-predicate").val();
                var objectVal;

                var objectSelect = row.find(".node-input-template-object");
                var objectPathInput = row.find(".node-input-template-object-path");

                if (objectPathInput.is(":visible") && objectPathInput.val().trim() !== "" && objectPathInput.val().trim() !== "msg.") {
                     objectVal = objectPathInput.val().trim();
                } else if (objectSelect.is(":visible")) {
                     objectVal = objectSelect.val();
                } else {
                     objectVal = ""; // Default if nothing selected/entered
                }

                // Exclude the placeholder value for msg path input
                if (objectVal === "msg.") {
                    objectVal = "";
                }
                    
                var enableStorage = row.find(".node-input-template-storage").is(":checked");
                
                if (subject && predicate && objectVal) {
                    templates.push({
                        subject: subject,
                        predicate: predicate,
                        object: objectVal, // Use determined object value
                        enableStorage: enableStorage
                    });
                }
            });
            
            node.templates = templates;
            
            // Save functions from dropdown selection
            var functions = [];
            var selectedTools = $("#node-input-tools-dropdown").val() || [];
            
            selectedTools.forEach(function(toolJson) {
                try {
                    var tool = JSON.parse(toolJson);
                    if (tool.name && tool.code) {
                functions.push({
                            name: tool.name,
                            code: tool.code
                });
                    }
                } catch (e) {
                    console.error("Error parsing tool JSON:", e);
                }
            });
            
            node.functions = functions;
            
            if (this._cleanUpComms) {
                this._cleanUpComms();
            }
        },
        oneditcancel: function() {
            // Mark that dialog is closed
            if (this._config_dialog_open) {
                this._config_dialog_open = false;
            }
            
            if (this.functionEditors) {
                for (var id in this.functionEditors) {
                    if (this.functionEditors.hasOwnProperty(id)) {
                        this.functionEditors[id].destroy();
                    }
                }
            }
            
            $('#unit-node-dialog-styles').remove();
            
            if (this._cleanUpComms) {
                this._cleanUpComms();
            }
        },
        oneditdelete: function() {
            // Mark that dialog is closed
            if (this._config_dialog_open) {
                this._config_dialog_open = false;
            }
            
            if (this.functionEditors) {
                for (var id in this.functionEditors) {
                    if (this.functionEditors.hasOwnProperty(id)) {
                        this.functionEditors[id].destroy();
                    }
                }
            }
            
            $('#unit-node-dialog-styles').remove();
            
            if (this._cleanUpComms) {
                this._cleanUpComms();
            }
        },
        _cleanUpComms: function() {
            if (this._outputMessageHandler) {
                RED.comms.unsubscribe("unit-node/" + this.id, this._outputMessageHandler);
                this._outputMessageHandler = null;
            }
        }
    });

    $(document).on('schema-data-loaded', function(event, data) {
        if (data) {
            window.schemaData = data;
            
            // Trigger update for all existing rows
            $(".node-input-template-subject").each(function() {
                $(this).trigger('change');
            });
        }
    });

</script>

<script type="text/html" data-template-name = "unit-node">
    <!-- Main container for two-column layout -->
    <div id="unit-node-editor-container" style="display: flex; width: 100%; height: 100%;">

        <!-- Left Column (70%): Existing Properties -->
        <div id="unit-node-properties-column" style="flex: 0 0 70%; padding-right: 15px; box-sizing: border-box; overflow-y: auto;">

            <div class="form-row">
                <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
                <input type="text" id="node-input-name" placeholder="Name">
            </div>

            <div class="form-row">
                <label for="node-input-prompt-container"><i class="fa fa-comment"></i> Prompt</label>
                <div style="display: inline-block; position: relative; width: 70%; height: 34px;">
                    <div style="position: absolute; left: 0; right: 0; top: 0; bottom: 0; display: flex; align-items: center; overflow: hidden; border: 1px solid #ccc; border-radius: 4px; padding: 0 8px; cursor: pointer;" id="node-input-prompt-container">
                        <div style="text-overflow: ellipsis; overflow: hidden; white-space: nowrap;" id="node-input-prompt-preview"></div>
                        <input type="hidden" id="node-input-prompt">
                    </div>
                </div>
            </div>

            <div class="form-row">
                <label for="node-input-objective-container"><i class="fa fa-bullseye"></i> Objective</label>
                <div style="display: inline-block; position: relative; width: 70%; height: 34px;">
                    <div style="position: absolute; left: 0; right: 0; top: 0; bottom: 0; display: flex; align-items: center; overflow: hidden; border: 1px solid #ccc; border-radius: 4px; padding: 0 8px; cursor: pointer;" id="node-input-objective-container">
                        <div style="text-overflow: ellipsis; overflow: hidden; white-space: nowrap;" id="node-input-objective-preview"></div>
                        <input type="hidden" id="node-input-objective">
                    </div>
                </div>
            </div>

            <!-- MQTT Section - Only Topic -->
            <div class="form-row">
                <label for="node-input-topic"><i class="fa fa-tasks"></i> MQTT Topic</label>
                <input type="text" id="node-input-topic" placeholder="topic">
            </div>

            <!-- Knowledge Graph Triplet Templates Section -->
            <!-- Triplet templates section with header and add button -->
            <div class="form-row">
                <label><i class="fa fa-list"></i> Triplet Templates</label>
                <a href="#" class="editor-button editor-button-small" id="node-input-add-template" style="margin-top:4px; padding: 4px 10px;">
                    <i class="fa fa-plus"></i> Add
                </a>
            </div>

            <!-- Compact template header row -->
            <div class="form-row" style="margin-top:10px; margin-bottom:5px; padding: 0 8px;">
                <div style="display: flex; width: 100%; padding-left: 100px; box-sizing: border-box;">
                    <div style="flex: 1; margin-right: 8px; font-weight: bold; font-size: 14px;">Subject</div>
                    <div style="flex: 1; margin-right: 8px; font-weight: bold; font-size: 14px;">Predicate</div>
                    <div style="flex: 1; margin-right: 8px; font-weight: bold; font-size: 14px;">Object</div>
                    <div style="margin-right: 8px; font-weight: bold; font-size: 14px;">Store</div>
                    <div style="width: 40px;"></div>
                </div>
            </div>

            <!-- Template container with compact styling -->
            <div style="padding-left: 100px; min-height: 120px; margin-bottom: 15px;" id="node-input-template-container">
                <!-- Template rows will be added here by JS -->
            </div>

            <!-- Custom Functions Section -->
            <div class="form-row" style="margin-top:20px; margin-bottom:10px;">
                <label><i class="fa fa-code"></i> Tools</label>
            </div>
            <div id="node-input-function-container">
                <!-- Function selector will be added here by JS -->
            </div>

            <!-- Moved Payload field here, after the Tools section -->
            <div class="form-row" style="margin-top:20px;">
                <label for="node-input-payload"><i class="fa fa-envelope"></i> Payload</label>
                <input type="text" id="node-input-payload" placeholder="Default payload">
            </div>

        </div> <!-- End Left Column -->

        <!-- Right Column (30%): Output Area -->
        <!-- Added height: 100% and flex-direction column for proper layout -->
        <div id="unit-node-output-column" style="flex: 1; padding-left: 5px; border-left: 1px solid #ccc;">
            <div id="node-output-preview" style="height: 100%; overflow-y: auto; font-family: monospace; font-size: 12px;">
                <!-- Output content will be populated here by JS -->
            </div>
        </div> <!-- End Right Column -->

    </div> <!-- End Main Container -->
</script>

<script type="text/html" data-help-name = "unit-node">
    <p>A node that processes input messages and creates knowledge graph triplets with customizable templates.</p>
    
    <h3>Features</h3>
    <ul>
        <li><b>Input Processing:</b> Processes incoming flow messages, applying the configured default payload.</li>
        <li><b>MQTT Integration:</b> Always connects to MQTT topics for message input and output.</li>
        <li><b>Knowledge Graph Templates:</b> Define triplets in subject-predicate-object format with dynamic values from message paths.</li>
        <li><b>Individual Storage Options:</b> Each triplet can be individually configured for storage using the common API endpoint.</li>
        <li><b>Tools:</b> Add multiple Python function tools to process messages with full access to Node-RED context variables.</li>
        <li><b>Automatic Debug Logging:</b> Always logs messages to the Node-RED debug panel without needing a separate debug node.</li>
    </ul>
    
    <h3>Triplet Format</h3>
    <p>Each triplet template consists of:</p>
    <ul>
        <li><b>Subject:</b> The entity that the triplet refers to (select from dropdown with predefined values)</li>
        <li><b>Predicate:</b> The relationship between subject and object (select from dropdown with predefined values)</li>
        <li><b>Object:</b> The object value or a path to extract from the message (e.g., "msg.payload.name")</li>
        <li><b>Store:</b> Whether to store this triplet via the API endpoint</li>
    </ul>
    
    <h3>Dynamic Values</h3>
    <p>You can use paths like "msg.payload.value" or "msg.topic" in the object field to dynamically extract values from incoming messages.</p>
    
    <h3>Subject and Predicate Options</h3>
    <p>The subject and predicate dropdowns are populated with predefined entities and relations.</p>
    
    <h3>Storage</h3>
    <p>Triplets marked for storage will be sent to the configured API endpoint. All triplets use the same endpoint, but you can choose which ones to store individually.</p>
    
    <h3>Tools</h3>
    <p>The Tools section allows you to define Python function tools to process messages with full access to Node-RED context variables.</p>
    <ul>
        <li><b>Important:</b> These Python functions are <em>not</em> executed by Node-RED.</li>
        <li>They serve as documentation and code examples only.</li>
        <li>The node will store these definitions and add their names to the outgoing messages as a reference.</li>
        <li>No actual Python code execution occurs within Node-RED.</li>
    </ul>
    <p>Tool functions use Python Doxygen-style documentation for standardized reference.</p>
    <p>Example Python tool documentation:</p>
    <pre>"""
Calculate the greatest common divisor of two numbers

Parameters
----------
a : int
    First integer
b : int
    Second integer

Returns
-------
int
    Greatest common divisor of a and b
"""
def gcd(a, b):
    """Compute the greatest common divisor of a and b"""
    while b:
        a, b = b, a % b
    return a

# Example usage
print(gcd(48, 18))  # 6
print(gcd(101, 103))  # 1</pre>
    
    <h3>Automatic Debug Logging</h3>
    <p>This node automatically logs all output messages to the Node-RED debug panel. No debug node is required in your flow.</p>
    <ul>
        <li>All messages processed by this node appear in the debug sidebar</li>
        <li>Messages show the full payload and all properties</li>
        <li>This happens automatically without needing to add a debug node to your flow</li>
    </ul>
    
    <h3>Example</h3>
    <p>For incoming message: <code>{"payload": {"name": "John", "symptom": "Headache"}}</code></p>
    <p>With templates:</p>
    <ul>
        <li>subject: "Patient", predicate: "has_appointment_with", object: "msg.payload.name"</li>
        <li>subject: "Patient", predicate: "has_symptom", object: "msg.payload.symptom"</li>
    </ul>
    <p>Produces triplets:</p>
    <ul>
        <li>(Patient, has_appointment_with, "John")</li>
        <li>(Patient, has_symptom, "Headache")</li>
    </ul>
</script>